name: CI/CD Pipeline

on:
  push:
    branches:
      - main   # runs when you push to main

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the code
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2️⃣ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'  # match your project Python

      # 3️⃣ Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install .

      # 4️⃣ Run tests
      - name: Run pytest
        run: pytest -v

      # 5️⃣ Deploy to Raspberry Pi (only if tests pass)
      - name: Deploy to Raspberry Pi
        if: success()  # only runs if previous steps succeeded
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.PI_HOST }}        # your Pi IP
          username: ${{ secrets.PI_USER }}    # Pi username
          key: ${{ secrets.PI_SSH_KEY }}      # private key
          port: 3000
          script: |
            cd /home/hunter/SmartThermostatController
            git pull
            pip install -e .
            mkdir yep_was_here # gunicorn -b 0.0.0.0 -w 4 'src:create_app()'
